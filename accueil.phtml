<?php
require_once "config.php";
require_once 'session.php';

$statistiqueDao = new StatistiqueDao($config);
$partieDao = new PartieDao($config);
$utilisateurDao = new UtilisateurDao($config);
$jeuDao = new JeuDao($config);

// Statistiques
$nbJoueurs = count($utilisateurDao->selectAllParRole(2));
$nbJeux = count($jeuDao->selectAll());
$nbParties = count($partieDao->selectAll());
$classement = $statistiqueDao->selectClassementGlobal();
$meilleurJoueur = count($classement) > 0 ? $classement[0] : null;

// Dernières parties
$dernieresParties = $partieDao->selectAll(6);
?>

<!DOCTYPE html>
<html lang="fr">

<head>
  <?php require_once 'section/head.phtml'; ?>
  <title>Accueil - Point Final</title>
</head>

<body class="g-sidenav-show bg-gray-100">
  <?php require_once 'section/entete.phtml'; ?>

  <main class="main-content px-4 py-4">
    <?php require_once 'section/retroaction.phtml'; ?>

    <!-- Titre principal -->
    <div class="mb-4 text-center">
      <h2 class="text-gradient text-primary fw-bold mb-2">Bienvenue sur Point Final !</h2>
      <p class="text-secondary text-sm mx-auto" style="max-width: 600px;">
        Point Final est simplement un site qui répertorie les résultats des parties jouées sur l'arcade du département afin de pouvoir "remettre dans la face" de ses adversaires leurs défaites!
      </p>
    </div>

    <!-- Section En bref -->
    <section class="mb-5 section-card">
      <h2 class="h5 text-dark mb-3">En bref</h2>
      <div class="row">
        <div class="col-12 col-sm-6 col-lg-3 mb-4">
          <div class="card shadow-sm border-radius-xl">
            <div class="card-body text-center">
              <h6 class="text-secondary text-sm mb-1">Nombre de joueurs</h6>
              <h4 class="font-weight-bold mb-0"><?= $nbJoueurs ?></h4>
            </div>
          </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3 mb-4">
          <div class="card shadow-sm border-radius-xl">
            <div class="card-body text-center">
              <h6 class="text-secondary text-sm mb-1">Nombre de jeux</h6>
              <h4 class="font-weight-bold mb-0"><?= $nbJeux ?></h4>
            </div>
          </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3 mb-4">
          <div class="card shadow-sm border-radius-xl">
            <div class="card-body text-center">
              <h6 class="text-secondary text-sm mb-1">Nombre de parties jouées</h6>
              <h4 class="font-weight-bold mb-0"><?= $nbParties ?></h4>
            </div>
          </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3 mb-4">
          <div class="card shadow-sm border-radius-xl">
            <div class="card-body text-center">
              <h6 class="text-secondary text-sm mb-1">Meilleur joueur actuel</h6>
              <h4 class="font-weight-bold mb-0">
                <?php if ($meilleurJoueur): ?>
                  <a href="profil.phtml?id=<?= $meilleurJoueur->getJoueurId() ?>" class="text-dark">
                    <?= htmlspecialchars($meilleurJoueur->getNomComplet()) ?>
                  </a>
                <?php else: ?>
                  Aucun
                <?php endif; ?>
              </h4>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section Dernières parties -->
    <section>
      <h2 class="h5 text-dark mb-3">Dernières parties jouées</h2>
      <div class="row">
        <?php foreach ($dernieresParties as $partie): ?>
          <div class="col-12 col-lg-6 mb-4">
            <div class="card p-3 shadow-sm border-radius-xl">
              <div class="row align-items-center">
                <!-- Joueur 1 -->
                <div class="col-4 text-center">
                  <img src="<?= $partie->getJoueur1()->getUrlAvatar() ?: 'assets/img/default-avatar.png' ?>" class="avatar avatar-lg rounded-circle mb-2" alt="Joueur 1">
                  <div class="text-sm"><?= htmlspecialchars($partie->getJoueur1()->getNomComplet()) ?></div>
                  <div><strong><?= $partie->getScoreJoueur1() ?></strong></div>
                </div>

                <!-- VS + jeu -->
                <div class="col-4 text-center">
                  <h5 class="text-dark mb-1">VS</h5>
                  <img src="<?= $partie->getJeu()->getUrlImageJeu() ?: 'assets/img/default-game.png' ?>"
     class="img-fluid my-2" width="64" height="64" alt="Jeu">

                  <div class="text-sm"><?= htmlspecialchars($partie->getJeu()->getNom()) ?></div>
                </div>

                <!-- Joueur 2 -->
                <div class="col-4 text-center">
                  <img src="<?= $partie->getJoueur2()->getUrlAvatar() ?: 'assets/img/default-avatar.png' ?>" class="avatar avatar-lg rounded-circle mb-2" alt="Joueur 2">
                  <div class="text-sm"><?= htmlspecialchars($partie->getJoueur2()->getNomComplet()) ?></div>
                  <div><strong><?= $partie->getScoreJoueur2() ?></strong></div>
                </div>
              </div>
              <div class="text-center mt-3 text-muted text-xs">
                Jouée le <?= $partie->getDateCreation()->format('d-m-Y à H:i') ?>
              </div>
            </div>
          </div>
        <?php endforeach; ?>
      </div>
    </section>
  </main>

  <?php require_once 'section/pied.phtml'; ?>
</body>

</html>
