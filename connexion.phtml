<?php
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

require_once "config.php";
require_once "session.php";

$utilisateurDao = new UtilisateurDao($config);
$erreurs = [];
$nomUtilisateur = '';

// Déconnexion si le paramètre est passé
if (isset($_GET['bouton-deconnexion'])) {
  detruireSession();
  header("Location: connexion.phtml");
  exit;
}

// Si l'utilisateur est déjà connecté, on redirige vers son profil
$utilisateurConnecte = getUtilisateurConnecte();
if ($utilisateurConnecte) {
    header("Location: profil.phtml?id=" . $utilisateurConnecte->getId());
    exit;
}

// Si un formulaire de connexion a été soumis
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['bouton-connexion'])) {
    $nomUtilisateur = trim($_POST['nom-utilisateur']);
    $motDePasse = $_POST['mot-de-passe'];

    $utilisateur = $utilisateurDao->selectParNomUtilisateur($nomUtilisateur);

    if ($utilisateur && password_verify($motDePasse, $utilisateur->getHash())) {
        $_SESSION['utilisateur'] = $utilisateur;
        $_SESSION['derniereActivite'] = time();
        header("Location: profil.phtml?id=" . $utilisateur->getId());
        exit;
    } else {
        $erreurs[] = "Nom d'utilisateur ou mot de passe invalide.";
    }
}
?>

<!DOCTYPE html>
<html lang="fr">

<head>
  <?php require_once 'section/head.phtml'; ?>
  <title>Connexion - Point Final</title>
</head>

<body class="bg-gray-100">
  <?php require_once 'section/entete.phtml'; ?>

  <main class="container" style="max-width: 500px; margin-top: 80px;">
    <?php require_once 'section/retroaction.phtml'; ?>

    <?php if (!empty($erreurs)): ?>
      <div class="alert alert-danger">
        <?php foreach ($erreurs as $erreur): ?>
          <div><?= htmlspecialchars($erreur) ?></div>
        <?php endforeach; ?>
      </div>
    <?php endif; ?>

    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="text-center mb-4 text-primary">Connexion</h2>

        <form method="post" autocomplete="off">
          <div class="mb-3">
            <input type="text"
                   class="form-control"
                   name="nom-utilisateur"
                   placeholder="Nom d'utilisateur"
                   required
                   value="<?= htmlspecialchars($nomUtilisateur) ?>">
          </div>

          <div class="mb-3">
            <input type="password"
                   class="form-control"
                   name="mot-de-passe"
                   placeholder="Mot de passe"
                   required>
          </div>

          <div class="d-grid">
            <button type="submit" class="btn btn-primary" name="bouton-connexion">Se connecter</button>
          </div>
        </form>

        <div class="text-center mt-4">
          <small>Pas de compte ? <a href="inscription.phtml">Inscrivez-vous ici</a>.</small>
        </div>
      </div>
    </div>
  </main>

  <?php require_once 'section/pied.phtml'; ?>
</body>

</html>
